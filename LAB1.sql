-- Tạo bảng
CREATE TABLE SINHVIEN(
	MSSV CHAR(8) NOT NULL,
	TENSV NVARCHAR(30) NOT NULL,
	SODT VARCHAR(10),
	LOP CHAR(10) NOT NULL,
	DIACHI NCHAR(50) NOT NULL,
    CONSTRAINT SV_MSSV_PK PRIMARY KEY (MSSV)
);
CREATE TABLE DETAI(
	MSDT CHAR(6) NOT NULL,
	TENDT NVARCHAR(30) NOT NULL,
    CONSTRAINT DT_MSDT_PK PRIMARY KEY (MSDT)
);

CREATE TABLE SV_DETAI(
	MSSV CHAR(8),
	MSDT CHAR(6),
	CONSTRAINT SV_DETAI_MSSV_MSDT_PK PRIMARY KEY(MSSV, MSDT)
);

CREATE TABLE HOCVI(
	MSHV INT,
	TENHV NVARCHAR(20) NOT NULL,
    CONSTRAINT HV_MSHV_PK PRIMARY KEY(MSHV)
);

CREATE TABLE HOCHAM(
	MSHH INT,
	TENHH NVARCHAR(20) NOT NULL,
	CONSTRAINT HH_MSHH_PK PRIMARY KEY (MSHH)
);

CREATE TABLE GIAOVIEN(
	MSGV CHAR(5) CONSTRAINT GV_MSGV_PK PRIMARY KEY,
	TENGV NVARCHAR(30) NOT NULL,
	DIACHI NVARCHAR(50) NOT NULL,
	SODT VARCHAR(10) NOT NULL,
	MSHH INT,
	NAMHH SMALLDATETIME NOT NULL
)

CREATE TABLE CHUYENNGANH(
	MSCN INT CONSTRAINT CN_MSCN_PK PRIMARY KEY,
	TENCN NVARCHAR(30) NOT NULL
)

CREATE TABLE GV_HV_CN(
	MSGV CHAR(5),
	MSHV INT,
	MSCN INT,
	NAM SMALLDATETIME NOT NULL
	CONSTRAINT GV_HV_CN_MS_PK PRIMARY KEY(MSGV, MSHV, MSCN)
)

CREATE TABLE GV_HDDT(
	MSGV CHAR(5),
	MSDT CHAR(6),
	DIEM FLOAT NOT NULL
	CONSTRAINT GV_HDDT_MSGV_MSDT_PK PRIMARY KEY(MSGV, MSDT)
)

CREATE TABLE GV_PBDT(
	MSGV CHAR(5),
	MSDT CHAR(6),
	DIEM FLOAT NOT NULL
	CONSTRAINT GV_PBDT_MSGV_MSDT PRIMARY KEY(MSGV, MSDT)
)

CREATE TABLE GV_UVDT(
	MSGV CHAR(5),
	MSDT CHAR(6),
	DIEM FLOAT NOT NULL
	CONSTRAINT GV_UVDT_MSGV_MSDT PRIMARY KEY(MSGV, MSDT)
)

CREATE TABLE HOIDONG(
	MSHD INT CONSTRAINT HD_MSHD_PK PRIMARY KEY,
	PHONG CHAR(3),
	TGBD SMALLDATETIME,
	NGAYHD SMALLDATETIME NOT NULL,
	TINHTRANG NVARCHAR(30),
	MSGV CHAR(5)
)

CREATE TABLE HOIDONG_GV(
	MSHD INT,
	MSGV CHAR(5)
	CONSTRAINT HDGV_MSHD_MSGV_PK PRIMARY KEY(MSHD, MSGV)
)

CREATE TABLE HOIDONG_DT(
	MSHD INT,
	MSDT CHAR(6),
	QUYETDINH NCHAR(10)
	CONSTRAINT HDDT_MSHD_MSGV_PK PRIMARY KEY(MSHD, MSDT)
)

-- Tạo khóa ngoại cho bảng SV_DETAI
ALTER TABLE SV_DETAI
ADD CONSTRAINT SV_DETAI_MSSV_FK FOREIGN KEY (MSSV) REFERENCES SINHVIEN(MSSV)

ALTER TABLE SV_DETAI
ADD CONSTRAINT SV_DETAI_MSDT_FK FOREIGN KEY (MSDT) REFERENCES DETAI(MSDT)

-- Tạo khóa ngoại cho bảng GIAOVIEN
ALTER TABLE GIAOVIEN
ADD CONSTRAINT FK_GIAOVIEN_HOCHAM FOREIGN KEY (MSHH) REFERENCES HOCHAM(MSHH)

-- Tạo khóa ngoại cho bảng GV_HV_CN
ALTER TABLE GV_HV_CN
ADD CONSTRAINT GV_HV_CN_MSGV_FK FOREIGN KEY (MSGV) REFERENCES GIAOVIEN(MSGV)

ALTER TABLE GV_HV_CN
ADD CONSTRAINT GV_HV_CN_HOCVI_FK FOREIGN KEY (MSHV) REFERENCES HOCVI(MSHV)

ALTER TABLE GV_HV_CN
ADD CONSTRAINT GV_HV_CN_CHUYENNGANH_FK FOREIGN KEY (MSCN) REFERENCES CHUYENNGANH(MSCN)

-- Tạo khóa ngoại cho bảng GV_HDDT
ALTER TABLE GV_HDDT
ADD CONSTRAINT GV_HDDT_MSGV_FK FOREIGN KEY (MSGV) REFERENCES GIAOVIEN(MSGV)

ALTER TABLE GV_HDDT
ADD CONSTRAINT GV_HDDT_MSDT_FK FOREIGN KEY (MSDT) REFERENCES DETAI(MSDT)

-- Tạo khóa ngoại cho bảng GV_PBDT
ALTER TABLE GV_PBDT
ADD CONSTRAINT GV_PBDT_MSGV_FK FOREIGN KEY (MSGV) REFERENCES GIAOVIEN(MSGV)

ALTER TABLE GV_PBDT
ADD CONSTRAINT GV_PBDT_MSDT_FK FOREIGN KEY (MSDT) REFERENCES DETAI(MSDT)

-- Tạo khóa ngoại cho bảng GV_UVDT
ALTER TABLE GV_UVDT
ADD CONSTRAINT GV_UVDT_MSGV_FK FOREIGN KEY (MSGV) REFERENCES GIAOVIEN(MSGV)

ALTER TABLE GV_UVDT
ADD CONSTRAINT GV_UVDT_MSDT_FK FOREIGN KEY (MSDT) REFERENCES DETAI(MSDT)

-- Tạo khóa ngoại cho bảng HOIDONG
ALTER TABLE HOIDONG
ADD CONSTRAINT FK_HOIDONG_GIAOVIEN FOREIGN KEY (MSGV) REFERENCES GIAOVIEN(MSGV)

-- Tạo khóa ngoại cho bảng HOIDONG_GV
ALTER TABLE HOIDONG_GV
ADD CONSTRAINT FK_HOIDONG_GV_HOIDONG FOREIGN KEY (MSHD) REFERENCES HOIDONG(MSHD)

ALTER TABLE HOIDONG_GV
ADD CONSTRAINT FK_HOIDONG_GV_GIAOVIEN FOREIGN KEY (MSGV) REFERENCES GIAOVIEN(MSGV)

-- Tạo khóa ngoại cho bảng HOIDONG_DT
ALTER TABLE HOIDONG_DT
ADD CONSTRAINT FK_HOIDONG_DT_HOIDONG FOREIGN KEY (MSHD) REFERENCES HOIDONG(MSHD)

ALTER TABLE HOIDONG_DT
ADD CONSTRAINT FK_HOIDONG_DT_DETAI FOREIGN KEY (MSDT) REFERENCES DETAI(MSDT)


-- Nhập dữ liệu cho các quan hệ trên
SET DATEFORMAT DMY 

-- Thêm dữ liệu cho bảng SINHVIEN
INSERT INTO SINHVIEN (MSSV, TENSV, SODT, LOP, DIACHI)
VALUES 
		('13520001', N'Nguyễn Văn An', '0906762255', 'SE103.U32', N'THỦ ĐỨC'),
		('13520002', N'Phan Tấn Đạt', '0975672350', 'IE204.T21', N'QUẬN 1'),
		('13520003', N'Nguyễn Anh Hải', '0947578868', 'IE205.R12', N'QUẬN 9'),
		('13520004', N'Phạm Tài', '0956757869', 'IE202.A22', N'QUẬN 1'),
		('13520005', N'Lê Thụy Hằng', '0976668688', 'SE304.E22', N'THỦ ĐỨC'),
		('13520006', N'Ưng Hồng Ân', '0957475898', 'IE208.F33', N'QUẬN 2')
		
	
-- Thêm dữ liệu cho bảng DETAI
INSERT INTO DETAI (MSDT, TENDT) 
VALUES 
		('97001', N'Quản lý thư viện'),
		('97002', N'Nhận dạng vân tay'),
		('97003', N'Bán đấu giá trên mạng'),
		('97004', N'Quản lý siêu thị'),
		('97005', N'Xử lý ảnh'),
		('97006', N'Hệ giải toán thông minh')

-- Thêm dữ liệu cho bảng DETAI
INSERT INTO SV_DETAI (MSSV, MSDT)
VALUES 
		('13520001', '97004'),
		('13520002', '97005'),
		('13520003', '97001'),
		('13520004', '97002'),
		('13520005', '97003'),
		('13520006', '97005')

-- Thêm dữ liệu vào bảng HOCHAM
INSERT INTO HOCHAM (MSHH, TENHH)
VALUES 
		('1', N'PHÓ GIÁO SƯ'),
		('2', N'GIÁO SƯ')

-- Thêm dữ liệu vào bảng GIAOVIEN
INSERT INTO GIAOVIEN (MSGV, TENGV, DIACHI, SODT, MSHH, NAMHH)
VALUES 
		('00201', N'Trần Trung', N'Bến Tre', '35353535', '1', '2020'),
		('00202', N'Nguyễn Văn An', N'Tiền Giang', '67868688', '1', '2016'),
		('00203', N'Trần Thu Trang', N'Cần Thơ', '74758687', '1', '2019'),
		('00204', N'Nguyễn Thị Loan', N'TP. HCM', '56575868', '2', '2021'),
		('00205', N'Chu Tiến', N'Hà Nội', '4646646464', '1', '2022')

-- Thêm dữ liệu vào bảng HOCVI
INSERT INTO HOCVI (MSHV, TENHV)
VALUES 
		('1', N'Kỹ sư'),
		('2', N'Cử nhân'),
		('3', N'Thạc sĩ'),
		('4', N'Tiến sĩ'),
		('5', N'Tiến sĩ khoa học')

-- Thêm dữ liệu vào bảng CHUYENGANH
INSERT INTO CHUYENNGANH (MSCN, TENCN)
VALUES 
		('1', N'Công nghệ Web'),
		('2', N'Mạng xã hội'),
		('3', N'Quản lý CNTT'),
		('4', N'GIS')

-- Thêm dữ liệu vào bảng GV_HV_CN
INSERT INTO GV_HV_CN (MSGV, MSHV, MSCN, NAM)
VALUES 
		('00201', '1', '1', '2013'),
		('00201', '1', '2', '2013'),
		('00201', '2', '1', '2014'),
		('00202', '3', '2', '2013'),
		('00203', '2', '4', '2014'),
		('00204', '3', '2', '2014')

-- Thêm dữ liệu vào bảng GV_HDDT
INSERT INTO GV_HDDT (MSGV, MSDT, DIEM)
VALUES 
		('00201', '97001', '8'),
		('00202', '97002', '7'),
		('00205', '97001', '9'),
		('00204', '97004', '7'),
		('00203', '97005', '9')

-- Thêm dữ liệu vào bảng GV_PBDT
INSERT INTO GV_PBDT (MSGV, MSDT, DIEM)
VALUES 
		('00201', '97005', '8'),
		('00202', '97001', '7'),
		('00205', '97004', '9'),
		('00204', '97003', '7'),
		('00203', '97002', '9')

-- Thêm dữ liệu vào bảng GV_UVDT
INSERT INTO GV_UVDT (MSGV, MSDT, DIEM)
VALUES 
		('00205', '97005', '8'),
		('00202', '97005', '7'),
		('00204', '97005', '9'),
		('00203', '97001', '7'),
		('00204', '97001', '9'),
		('00205', '97001', '8'),
		('00203', '97003', '7'),
		('00201', '97003', '9'),
		('00202', '97003', '7'),
		('00201', '97004', '9'),
		('00202', '97004', '8'),
		('00203', '97004', '7'),
		('00201', '97002', '9'),
		('00204', '97002', '7'),
		('00205', '97002', '9'),
		('00201', '97006', '9'),
		('00202', '97006', '7'),
		('00204', '97006', '9')

-- Thêm dữ liệu vào bảng HOIDONG
INSERT INTO HOIDONG (MSHD, PHONG, TGBD, NGAYHD, TINHTRANG, MSGV)
VALUES 
		('1', '002', '7:00', '29/11/2014', N'Thật', '00201'),
		('2', '102', '7:00', '5/12/2014', N'Thật', '00202'),
		('3', '003', '8:00', '6/12/2014', N'Thật', '00203')

-- Thêm dữ liệu vào bảng HOIDONG_GV
INSERT INTO HOIDONG_GV (MSHD, MSGV)
VALUES 
		('1', '00201'),
		('1', '00202'),
		('1', '00203'),
		('1', '00204'),
		('2', '00203'),
		('2', '00202'),
		('2', '00205'),
		('2', '00204'),
		('3', '00201'),
		('3', '00202'),
		('3', '00203'),
		('3', '00204')

-- Thêm dữ liệu vào bảng HOIDONG_DT
INSERT INTO HOIDONG_DT (MSHD, MSDT, QUYETDINH)
VALUES 
		('1', '97001', N'Được'),
		('1', '97002', N'Được'),
		('2', '97001', N'Không'),
		('2', '97004', N'Không'),
		('1', '97005', N'Được'),
		('3', '97001', N'Không'),
		('3', '97002', N'Được')

-- Thực hiện các truy vấn sau bằng ngôn ngữ SQL: 
/* d1. Với những sinh viên tham gia lớp có mã lớp (LOP) bắt đầu bằng 
ký hiệu ‘IE’, liệt kê MSSV, TENSV và mã lớp (LOP) mà sinh viên đó tham gia. */
SELECT MSSV, TENSV, LOP
FROM SINHVIEN
WHERE LOP LIKE 'IE%'

-- d2. Cho biết số lượng sinh viên sống ở ‘QUẬN 1’ (DIACHI). 
SELECT COUNT(MSSV) AS SLSV
FROM SINHVIEN
WHERE DIACHI = N'QUẬN 1'


-- d3. Cho biết danh sách giáo viên gồm MSGV, TENGV, DIACHI, SODT, TENHH của từng giáo viên. 
SELECT MSGV, TENGV, DIACHI, SODT, TENHH
FROM GIAOVIEN GV JOIN HOCHAM HH ON GV.MSHH = HH.MSHH

-- d4. Cho biết danh sách đề tài gồm MSDT, TENDT và số lượng sinh viên thực hiện của mỗi đề tài (nếu có). 
SELECT DT.MSDT, TENDT, COUNT(SV.MSSV) AS SLSV
FROM SINHVIEN SV, DETAI DT, SV_DETAI SVDT
WHERE SV.MSSV = SVDT.MSSV
	AND SVDT.MSDT = DT.MSDT
GROUP BY DT.MSDT, TENDT

SELECT DT.MSDT, TENDT, COUNT(SV.MSSV) AS SLSV
FROM SV_DETAI SVDT 
JOIN SINHVIEN SV ON SV.MSSV = SVDT.MSSV 
JOIN DETAI DT ON DT.MSDT = SVDT.MSDT
GROUP BY DT.MSDT, TENDT

/*d5. Liệt kê danh sách đề tài (MSDT, TENDT) và tên giáo viên hướng dẫn (TENGV) 
tương ứng, sắp xếp theo mã số đề tài tăng dần. */
SELECT DT.MSDT, TENDT, TENGV
FROM GV_HDDT GVHD
JOIN GIAOVIEN GV ON GV.MSGV = GVHD.MSGV
JOIN DETAI DT ON DT.MSDT = GVHD.MSDT
ORDER BY DT.MSDT ASC

-- d6. Cho biết số lượng đề tài (SLDT) đã hướng dẫn ứng với từng giáo viên (TENGV). 
SELECT GV.MSGV, TENGV, COUNT(MSDT) AS 'SLDT'
FROM GV_HDDT GVHD JOIN GIAOVIEN GV ON GV.MSGV = GVHD.MSGV
GROUP BY GV.MSGV, TENGV

-- d7. Liệt kê danh sách giáo viên (MSGV, TENGV) chưa hướng dẫn đề tài nào. 
SELECT MSGV, TENGV
FROM GIAOVIEN
EXCEPT
SELECT GV.MSGV, TENGV
FROM GIAOVIEN GV,GV_HDDT GH
WHERE GH.MSGV = GV.MSGV

-- d8. Cho biết giáo viên (MSGV, TENGV) nào hướng dẫn nhiều đề tài nhất. 
SELECT TOP 1 WITH TIES GV.MSGV, GV.TENGV, COUNT(GVHD.MSDT) AS SLDT
FROM GIAOVIEN GV
JOIN GV_HDDT GVHD ON GV.MSGV = GVHD.MSGV
GROUP BY GV.MSGV, GV.TENGV
ORDER BY SLDT DESC

-- d9*. Liệt kê danh sách giáo vên theo định dạng sau: MSGV, <TENHV TENGV>. 
 SELECT MSGV + ', ' + TENHH + ' ' + TENGV AS GIAOVIEN
 FROM GIAOVIEN GV JOIN HOCHAM HH ON GV.MSHH = HH.MSHH

-- d10*. Liệt kê danh sách giáo viên theo định dạng sau: <TENHV TENCN>. TENGV. 
SELECT TENHV + ' ' + TENCN + '. ' + TENGV AS GIAOVIEN
FROM GV_HV_CN HVCN
JOIN GIAOVIEN GV ON GV.MSGV = HVCN.MSGV
JOIN HOCVI HV ON HV.MSHV = HVCN.MSHV
JOIN CHUYENNGANH CN ON CN.MSCN = HVCN.MSCN
